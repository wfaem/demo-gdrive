import{jsx as u,jsxs as k}from"@dropins/tools/preact-jsx-runtime.js";import{Slot as $,classes as z}from"@dropins/tools/lib.js";import{g as V,c as F,u as O,T as R,F as tt,B as q}from"./useInLineAlert.js";import{useState as g,useCallback as E,useEffect as Q,useMemo as at}from"@dropins/tools/preact-hooks.js";import"@dropins/tools/event-bus.js";import"@dropins/tools/recaptcha.js";import{a as rt}from"./getCustomerToken.js";import{r as ot}from"./resendConfirmationEmail.js";import{s as st,a as et}from"./simplifyTransformAttributesForm.js";import{c as it}from"./confirmEmail.js";import{useText as W}from"@dropins/tools/i18n.js";import{InLineAlert as nt,InputPassword as mt}from"@dropins/tools/components.js";import{E as ct}from"./EmailConfirmationForm.js";const ut=({emailConfirmationStatusMessage:t,translations:r,initialEmailValue:e,routeSignUp:d,routeForgotPassword:m,routeRedirectOnSignIn:_,onErrorCallback:w,setActiveComponent:a,onSuccessCallback:f,onSignUpLinkClick:h,handleSetInLineAlertProps:o,routeRedirectOnEmailConfirmationClose:b})=>{const[A,P]=g(""),[L,n]=g(!1),[C,l]=g(""),[T,y]=g(!1),[M,S]=g({userName:"",status:!1}),[B,I]=g(!1),[x,N]=g([]),p=E(async i=>{o(),n(!0),y(!1),N([]),await ot(i)},[o]),U=E(i=>{i.length?y(!1):y(!0),l(i)},[]);Q(()=>{t!=null&&t.text&&o({text:t.text,type:t.status?t.status:void 0})},[t,o]);const v=E(async i=>{var H;o(),I(!0);const c=V(i.target);if(c.password||(y(!0),I(!1)),c!=null&&c.email&&(c!=null&&c.password)){const{email:K,password:Y}=c,s=await rt({email:K,password:Y,handleSetInLineAlertProps:o,onErrorCallback:w,translations:r});if((H=s==null?void 0:s.errorMessage)!=null&&H.length){P(K);const J=s.errorMessage.includes("This account isn't confirmed. Verify and try again."),Z=J?r.resendEmailInformationText:s.errorMessage;N(J?[{label:r.resendEmailButtonText,onClick:()=>{p(K)}}]:[]),o({text:Z,type:"error"}),l("")}s!=null&&s.userName&&(i.target.reset(),F(_)?window.location.href=_():(f==null||f({userName:s==null?void 0:s.userName,status:!0}),S({userName:s==null?void 0:s.userName,status:!0}))),y(!1)}I(!1)},[o,w,r,p,_,f]),j=E(()=>{if(F(a)){a("resetPasswordForm");return}F(m)&&(window.location.href=m())},[m,a]),D=E(()=>{if(F(h)&&h(),F(a)){a("signUpForm");return}F(d)&&(window.location.href=d())},[h,d,a]),G=at(()=>{const i=st(et);return e!=null&&e.length?i==null?void 0:i.map(c=>({...c,defaultValue:e})):i},[e]),X=E(()=>{o(),F(b)?window.location.href=b():n(!1)},[o,b]);return{additionalActionsAlert:x,userEmail:A,defaultEnhancedEmailFields:G,passwordError:T,isSuccessful:M,isLoading:B,signInPasswordValue:C,showEmailConfirmationForm:L,setShowEmailConfirmationForm:n,setSignInPasswordValue:l,submitLogInUser:v,forgotPasswordCallback:j,onSignUpLinkClickCallback:D,handledOnPrimaryButtonClick:X,handleSetPassword:U}},ft=()=>{let t=new URL(window.location.href),r=t.searchParams.get("email"),e=t.searchParams.get("key");r&&e&&(t.searchParams.delete("email"),t.searchParams.delete("key"),window.history.replaceState({},document.title,t.toString()))},lt=({enableEmailConfirmation:t})=>{const r=W({accountConfirmMessage:"Auth.EmailConfirmationForm.accountConfirmMessage",accountConfirmationEmailSuccessMessage:"Auth.EmailConfirmationForm.accountConfirmationEmailSuccessMessage"}),[e,d]=g({text:"",status:""});return Q(()=>{if(t){const{search:m}=window.location;m.includes("email=")&&m.includes("key=")&&(async()=>{var f,h,o;const w=new URLSearchParams(m),a=await it({customerEmail:w.get("email"),customerConfirmationKey:w.get("key")});if(!a)return null;(f=a==null?void 0:a.errors)!=null&&f.length?d({text:a==null?void 0:a.errors[0].message,status:"error"}):(d({text:a.data.confirmEmail.customer.email?r.accountConfirmationEmailSuccessMessage.replace("{email}",(o=(h=a==null?void 0:a.data)==null?void 0:h.confirmEmail.customer)==null?void 0:o.email):r.accountConfirmMessage,status:"success"}),ft())})()}},[t,r]),{emailConfirmationStatusMessage:e}},pt=({slots:t,labels:r,formSize:e="default",initialEmailValue:d="",renderSignUpLink:m=!1,enableEmailConfirmation:_=!1,hideCloseBtnOnEmailConfirmation:w=!1,routeRedirectOnEmailConfirmationClose:a,routeRedirectOnSignIn:f,routeForgotPassword:h,routeSignUp:o,onSuccessCallback:b,setActiveComponent:A,onErrorCallback:P,onSignUpLinkClick:L})=>{const n=W({title:"Auth.SignInForm.title",buttonPrimary:"Auth.SignInForm.buttonPrimary",buttonSecondary:"Auth.SignInForm.buttonSecondary",buttonTertiary:"Auth.SignInForm.buttonTertiary",resendEmailInformationText:"Auth.Notification.resendEmailNotification.informationText",resendEmailButtonText:"Auth.Notification.resendEmailNotification.buttonText",customerTokenErrorMessage:"Auth.Api.customerTokenErrorMessage",placeholder:"Auth.InputPassword.placeholder",floatingLabel:"Auth.InputPassword.floatingLabel"}),{emailConfirmationStatusMessage:C}=lt({enableEmailConfirmation:_}),{inLineAlertProps:l,handleSetInLineAlertProps:T}=O(),{userEmail:y,additionalActionsAlert:M,defaultEnhancedEmailFields:S,passwordError:B,isSuccessful:I,isLoading:x,signInPasswordValue:N,showEmailConfirmationForm:p,submitLogInUser:U,forgotPasswordCallback:v,onSignUpLinkClickCallback:j,handledOnPrimaryButtonClick:D,handleSetPassword:G}=ut({translations:n,emailConfirmationStatusMessage:C,initialEmailValue:d,routeSignUp:o,routeForgotPassword:h,routeRedirectOnSignIn:f,setActiveComponent:A,onErrorCallback:P,onSuccessCallback:b,onSignUpLinkClick:L,handleSetInLineAlertProps:T,routeRedirectOnEmailConfirmationClose:a});return I.status&&(t!=null&&t.SuccessNotification)?u($,{"data-testid":"successNotificationTestId",name:"SuccessNotification",slot:t==null?void 0:t.SuccessNotification,context:{isSuccessful:I}}):p?u(ct,{formSize:e,userEmail:y,inLineAlertProps:l,hideCloseBtnOnEmailConfirmation:w,handleSetInLineAlertProps:T,onPrimaryButtonClick:D}):k("div",{className:z(["auth-signInForm",e]),"data-testid":"signInForm",children:[u(R,{text:(r==null?void 0:r.formTitleText)??n.title,bottomLine:!1,className:"auth-signInForm__title"}),l.text?u(nt,{"data-testid":"authInLineAlert",className:"auth-signInForm__notification",type:l.type,variant:"secondary",heading:l.text,icon:l.icon,additionalActions:M}):null,k(tt,{name:"signIn_form",className:"auth-signInForm__form",submitCallback:U,isLoading:x,fieldsConfig:S,children:[u(mt,{hideStatusIndicator:!0,className:"auth-signInForm__form__password",autoComplete:"current-password",error:B,defaultValue:N,onValue:G,placeholder:n.placeholder,floatingLabel:n.floatingLabel}),k("div",{className:"auth-signInForm__form__buttons",children:[k("div",{className:"auth-signInForm__form__buttons--combine",children:[u(q,{type:"button",variant:"tertiary",style:{padding:0},buttonText:n.buttonTertiary,className:"auth-signInForm__button auth-signInForm__button--forgot",enableLoader:!1,onClick:v,"data-testid":"switchToSignUp"}),m?u("span",{}):null,m?u(q,{type:"button",variant:"tertiary",style:{padding:0},buttonText:n.buttonSecondary,className:"auth-signInForm__button auth-signInForm__button--signup",enableLoader:!1,onClick:j}):null]}),u(q,{type:"submit",buttonText:(r==null?void 0:r.primaryButtonText)??n.buttonPrimary,variant:"primary",className:"auth-signInForm__button auth-signInForm__button--submit",enableLoader:x})]})]}),u("div",{id:"generateCustomerToken"})]})};export{pt as S};
